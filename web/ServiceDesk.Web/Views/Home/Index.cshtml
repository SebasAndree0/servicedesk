@model ServiceDesk.Web.Models.DashboardViewModel
@using ServiceDesk.Web.Models.Tickets

@{
    ViewData["Title"] = "Panel";

    var rolesCsv = (Context.Session.GetString("roles") ?? "");
    var roles = rolesCsv.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
    var esAdmin = roles.Any(r => r.Equals("Admin", StringComparison.OrdinalIgnoreCase));
}

<style>
    .panel-hero {
        background: rgba(20, 24, 33, .72);
        border: 1px solid rgba(255,255,255,.10);
        box-shadow: 0 16px 50px rgba(0,0,0,.35);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 18px 18px;
    }

    .muted { color: rgba(255,255,255,.65); }

    .stat-card {
        background: rgba(20, 24, 33, .72);
        border: 1px solid rgba(255,255,255,.10);
        box-shadow: 0 10px 30px rgba(0,0,0,.28);
        border-radius: 16px;
        transition: transform .15s ease, border-color .15s ease, background .15s ease;
        overflow: hidden;
        position: relative;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        border-color: rgba(13,110,253,.35);
        background: rgba(24, 28, 38, .78);
    }
    .stat-accent {
        height: 3px;
        background: linear-gradient(90deg, rgba(13,110,253,.0), rgba(13,110,253,.9), rgba(32,201,151,.8), rgba(13,110,253,.0));
        opacity: .9;
    }
    .stat-accent.admin {
        background: linear-gradient(90deg, rgba(255,193,7,.0), rgba(255,193,7,.95), rgba(13,110,253,.85), rgba(255,193,7,.0));
    }

    .panel-card {
        background: rgba(20, 24, 33, .72);
        border: 1px solid rgba(255,255,255,.10);
        box-shadow: 0 16px 50px rgba(0,0,0,.35);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
    }

    .badge-admin {
        border: 1px solid rgba(255,193,7,.35);
        background: rgba(255,193,7,.12);
        color: #ffdd7a;
    }

    .btn-soft {
        background: rgba(255,255,255,.06);
        border: 1px solid rgba(255,255,255,.12);
        color: #fff;
    }
    .btn-soft:hover {
        background: rgba(255,255,255,.10);
        border-color: rgba(255,255,255,.18);
        color: #fff;
    }

    .table thead th {
        color: rgba(255,255,255,.55) !important;
        font-weight: 600;
        letter-spacing: .2px;
        border-bottom-color: rgba(255,255,255,.10) !important;
    }
    .table td, .table th {
        border-top-color: rgba(255,255,255,.08) !important;
    }

    .title-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: rgba(13,110,253,.95);
        box-shadow: 0 0 0 6px rgba(13,110,253,.14);
    }
</style>

@if (ViewBag.Error != null)
{
    <div class="alert alert-danger">@ViewBag.Error</div>
}

@{
    var latest = Model?.Latest ?? new List<TicketResponse>();

    var openCount = Model?.Open ?? 0;
    var inProgressCount = Model?.InProgress ?? 0;
    var closedCount = Model?.Closed ?? 0;
    var totalCount = Model?.TotalTickets ?? 0;
}

<div class="panel-hero mb-3">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div>
            <div class="d-flex align-items-center gap-2">
                <span class="title-dot"></span>
                <h2 class="mb-0">Panel</h2>

                @if (esAdmin)
                {
                    <span class="badge badge-admin">Administrador</span>
                }
            </div>
            <div class="muted small mt-1">Resumen rápido del ServiceDesk.</div>
        </div>

        <div class="d-flex gap-2">
            <a class="btn btn-soft" href="/Tickets">Ver tickets</a>
            <a class="btn btn-primary" href="/Tickets/Create">Nuevo ticket</a>
        </div>
    </div>

    @if (esAdmin)
    {

    }
</div>

<div class="row g-3 mb-3">
    <div class="col-12 col-md-6 col-lg-3">
        <div class="stat-card h-100">
            <div class="stat-accent @(esAdmin ? "admin" : "")"></div>
            <div class="card-body p-4">
                <div class="muted small">Total</div>
                <div class="display-6 mb-0">@totalCount</div>
                <div class="muted small mt-2">Tickets registrados</div>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
        <div class="stat-card h-100">
            <div class="stat-accent"></div>
            <div class="card-body p-4">
                <div class="muted small">Abiertos</div>
                <div class="display-6 mb-0">@openCount</div>
                <div class="muted small mt-2">Pendientes de atención</div>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
        <div class="stat-card h-100">
            <div class="stat-accent"></div>
            <div class="card-body p-4">
                <div class="muted small">En progreso</div>
                <div class="display-6 mb-0">@inProgressCount</div>
                <div class="muted small mt-2">Siendo trabajados</div>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
        <div class="stat-card h-100">
            <div class="stat-accent"></div>
            <div class="card-body p-4">
                <div class="muted small">Cerrados</div>
                <div class="display-6 mb-0">@closedCount</div>
                <div class="muted small mt-2">Resueltos</div>
            </div>
        </div>
    </div>
</div>

<div class="panel-card">
    <div class="p-3 p-md-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h5 class="mb-0">Últimos tickets</h5>
                <div class="muted small">Actividad reciente</div>
            </div>

            <div class="muted small">Mostrando últimos 5</div>
        </div>

        <div class="table-responsive mt-2">
            <table class="table table-dark table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th>Título</th>
                        <th>Estado</th>
                        <th>Prioridad</th>
                        <th>Creado por</th>
                        <th>Asignado</th>
                        <th class="text-nowrap">Actualizado</th>
                    </tr>
                </thead>

                <tbody>
                @if (latest.Count == 0)
                {
                    <tr>
                        <td colspan="6" class="muted text-center py-5">
                            No hay tickets para mostrar.
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var t in latest)
                    {
                        // ✅ Status string: "Open" | "InProgress" | "Closed"
                        var statusText = (t.Status ?? "").Trim();

                        var statusClass = statusText switch
                        {
                            "Closed" => "bg-success",
                            "InProgress" => "bg-info text-dark",
                            _ => "bg-warning text-dark"
                        };

                        var statusLabel = statusText switch
                        {
                            "Closed" => "Cerrado",
                            "InProgress" => "En progreso",
                            _ => "Abierto"
                        };

                        // ✅ Priority string: "P1" | "P2" | "P3"
                        var prioText = (t.Priority ?? "P3").Trim();

                        var prioClass = prioText switch
                        {
                            "P1" => "bg-danger",
                            "P2" => "bg-warning text-dark",
                            _ => "bg-secondary"
                        };

                        <tr>
                            <td>
                                <div class="d-flex flex-column">
                                    <a href="/Tickets/Details/@t.Id" class="text-decoration-none fw-semibold">
                                        @t.Title
                                    </a>
                                    <span class="muted small">ID: @t.Id.ToString().Substring(0, 8)</span>
                                </div>
                            </td>

                            <td><span class="badge @statusClass">@statusLabel</span></td>
                            <td><span class="badge @prioClass">@prioText</span></td>
                            <td class="text-nowrap">@t.CreatedBy</td>
                            <td class="text-nowrap">@(t.AssignedTo ?? "-")</td>
                            <td class="text-nowrap">@t.UpdatedAtUtc.ToLocalTime().ToString("dd-MM-yyyy HH:mm")</td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>

        <div class="mt-3 d-flex justify-content-end">
            <a class="btn btn-soft" href="/Tickets">Ver todos</a>
        </div>
    </div>
</div>
